ALLOWLIST_FILE=".husky/large-files-allowlist.txt"
TICKET_TEMPLATE=".husky/large-file-ticket-template.txt"
LINE_LIMIT=250

git diff --cached --name-only --diff-filter=ACM | \
  grep -v "node_modules\|\.next\|\.git" | \
  while read file; do
    if [ -f "$file" ]; then
      if echo "$file" | grep -qE '\.(test|spec)\.(ts|tsx|js|jsx)$|\.md$|\.mdx$'; then
        continue
      fi

      if [ -f "$ALLOWLIST_FILE" ] && grep -q "^${file}$" "$ALLOWLIST_FILE"; then
        continue
      fi

      lines=$(wc -l < "$file" | tr -d ' ')
      if [ "$lines" -gt "$LINE_LIMIT" ]; then
        echo "‚ö†Ô∏è  Large file committed: $file ($lines lines, limit $LINE_LIMIT)"
        if command -v bd &> /dev/null; then
          existing=$(bd query "status:open label:large-file" 2>/dev/null | grep "$file" || true)
          if [ -z "$existing" ]; then
            desc=$(sed "s/{LINE_LIMIT}/$LINE_LIMIT/g; s/{LINES}/$lines/g; s/{FILE}/$file/g" "$TICKET_TEMPLATE")
            bd create "Refactor $file ($lines lines)" \
              -d "$desc" \
              -p 2 \
              -l "large-file,refactor" \
              --silent
            echo "   üìã Beads ticket created"
          else
            echo "   üìã Ticket already exists"
          fi
        fi
      fi
    fi
  done

# ‚îÄ‚îÄ Next.js 16 conventions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
NEXTJS_FAIL=0

# proxy.ts, not middleware.ts
if git diff --cached --name-only | grep -q '^middleware\.\(ts\|js\)$'; then
  echo "‚ùå Next.js 16 uses proxy.ts, not middleware.ts"
  echo "   Rename: git mv middleware.ts proxy.ts"
  echo "   Export:  export function proxy(request) {}"
  echo "   Verify: context7 nextjs proxy.ts file convention"
  NEXTJS_FAIL=1
fi

# Catch 'export function middleware' in proxy.ts
if git diff --cached --name-only | grep -q '^proxy\.\(ts\|js\)$'; then
  if git diff --cached -U0 proxy.ts 2>/dev/null | grep -q '+.*export.*function middleware'; then
    echo "‚ùå proxy.ts must export 'proxy', not 'middleware'"
    NEXTJS_FAIL=1
  fi
fi

# No pages router ‚Äî this project uses app router only
if git diff --cached --name-only --diff-filter=A | grep -q '^pages/'; then
  echo "‚ùå This project uses app/ router only ‚Äî do not add files to pages/"
  NEXTJS_FAIL=1
fi

if [ "$NEXTJS_FAIL" -ne 0 ]; then
  echo ""
  echo "See: https://nextjs.org/docs/app/guides/upgrading/version-16"
  exit 1
fi

npx --no-install lint-staged
